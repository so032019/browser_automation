# auto_repost システム技術設計書

## 概要

auto_repostは、X（旧Twitter）の自動化ツールで、Playwrightを使用してブラウザ操作を行い、検索・フォロー・リポスト・いいねの処理を自動実行するシステムです。

## システム全体アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                    main.py (エントリーポイント)                    │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────┴───────────────────────────────────────┐
│                  コア処理フロー                                │
│  1. ブラウザ起動・設定                                          │
│  2. ログイン処理                                              │
│  3. 検索実行                                                 │
│  4. URL収集（スクロール付き）                                   │
│  5. 各ポストでアクション実行                                     │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────┴───────────────────────────────────────┐
│                  コンポーネント層                               │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │
│  │BrowserManager│ │LoginHandler │ │SearchHandler│ │ActionHandler│ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────┴───────────────────────────────────────┐
│                  ユーティリティ層                              │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │
│  │   Config    │ │   Logger    │ │SelectorMgr  │ │SlackNotifier│ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 処理フロー詳細

### 1. システム初期化フェーズ

#### 1.1 設定読み込み (Config)
- **ファイル**: `src/utils/config.py`
- **処理内容**:
  - `.env`ファイルから認証情報を読み込み
  - 実行パラメータ（最大ポスト数、遅延時間等）を設定
  - 設定値のバリデーション実行

```python
# 主要設定項目
- X_USERNAME: Xアカウントのユーザー名
- X_PASSWORD: Xアカウントのパスワード
- MAX_POSTS_PER_SESSION: 1回の実行で処理する最大ポスト数
- DELAY_MIN/MAX: アクション間の遅延時間範囲
- HEADLESS: ヘッドレスモード設定
- STEALTH_MODE: ステルスモード設定
- BROWSER_PATH: カスタムブラウザパス
- LOG_DIR: ログ出力ディレクトリ
- SLACK_API_URL: Slack通知API URL
- SLACK_API_KEY: Slack通知API認証キー
- SLACK_WORKSPACE: Slack通知ワークスペース
```

#### 1.2 ログシステム初期化 (Logger)
- **ファイル**: `src/utils/logger.py`
- **処理内容**:
  - 複数のログハンドラーを設定
  - ログレベル別の出力先を管理
  - ログローテーション機能
  - カスタムログディレクトリ対応

```python
# ログ出力先（LOG_DIRで指定可能）
- コンソール出力: INFO以上
- 一般ログファイル: {LOG_DIR}/x_automation_YYYYMMDD.log
- エラーログファイル: {LOG_DIR}/x_automation_error_YYYYMMDD.log
- デバッグログファイル: {LOG_DIR}/x_automation_debug_YYYYMMDD.log (デバッグモード時)

# ログディレクトリ設定例
LOG_DIR=logs                    # デフォルト
LOG_DIR=./custom_logs          # 相対パス
LOG_DIR=/var/log/x_automation  # 絶対パス
```

### 2. ブラウザ管理フェーズ

#### 2.1 ブラウザ起動 (BrowserManager)
- **ファイル**: `src/automation/browser_manager.py`
- **処理内容**:
  - Chromiumブラウザの起動
  - ステルスモード設定の適用
  - Cookie保存ディレクトリの管理

```python
# ブラウザ起動オプション
- --no-sandbox: サンドボックス無効化
- --disable-setuid-sandbox: setuidサンドボックス無効化
- --disable-dev-shm-usage: 共有メモリ使用量制限
- --disable-blink-features=AutomationControlled: 自動化検出回避
```

#### 2.2 ステルスモード設定
- **目的**: ブラウザ自動化の検出を回避
- **実装内容**:
  - WebDriverフラグの削除
  - User-Agentの偽装
  - プラグイン情報の偽装
  - WebGL情報の偽装

```javascript
// 主要なステルス設定
Object.defineProperty(navigator, 'webdriver', {
    get: () => undefined,
});

window.chrome = { runtime: {} };

Object.defineProperty(navigator, 'plugins', {
    get: () => [1, 2, 3, 4, 5],
});
```

#### 2.3 Cookie管理
- **保存場所**: `/tmp/x_automation_profile/state.json`
- **処理内容**:
  - ログイン状態の永続化
  - セッション情報の保存
  - 次回実行時の自動ログイン

### 3. ログイン処理フェーズ

#### 3.1 ログイン状態確認 (LoginHandler)
- **ファイル**: `src/automation/login_handler.py`
- **処理内容**:
  - X.comへのアクセス
  - 既存ログイン状態の確認
  - ログイン要素の検出

```python
# ログイン状態確認要素
login_indicators = [
    "[data-testid='SideNav_NewTweet_Button']",
    "[data-testid='primaryColumn']",
    "nav[role='navigation']"
]
```

#### 3.2 ログイン実行
- **処理手順**:
  1. ログインボタンのクリック
  2. ユーザー名の入力
  3. 次へボタンのクリック
  4. パスワードの入力
  5. ログイン完了の確認

#### 3.3 エラーハンドリング
- **エラー検出**:
  - パスワード間違い
  - ユーザー名不正
  - アカウントロック
  - 認証失敗

```python
# エラーメッセージ検出セレクタ
error_selectors = [
    "[data-testid='error-message']",
    "[role='alert']",
    ".error-message"
]
```

### 4. 検索処理フェーズ

#### 4.1 検索クエリ生成 (SearchHandler)
- **ファイル**: `src/automation/search_handler.py`
- **処理内容**:
  - 日付ベースのキーワード生成
  - URLエンコード処理
  - 検索パラメータの構築

```python
# 検索クエリ例
current_date = datetime.now()
date_str = current_date.strftime("%m/%d")
query = f"リポスト フォロー {date_str}"
encoded_query = urllib.parse.quote(query)
```

#### 4.2 直接URL検索実行
- **処理手順**:
  1. 検索URLの構築（https://x.com/search?q=（検索文字列）&src=typed_query&f=live）
  2. 検索ページへの直接ナビゲーション
  3. ページ読み込み完了の待機
  4. 検索結果表示の確認

```python
# 検索URL構築例
base_url = "https://x.com/search"
params = {
    'q': query,
    'src': 'typed_query',
    'f': 'live'  # 最新ツイート表示
}
search_url = f"{base_url}?{urllib.parse.urlencode(params)}"
```

#### 4.3 URL収集（スクロール機能付き）
- **処理内容**:
  - 検索結果からポストURLを抽出
  - スクロールによる追加コンテンツ読み込み
  - 重複URLの除去
  - 目標数に達するまで継続

```python
# URL抽出パターン
post_pattern = r'https://x\.com/[^/]+/status/\d+'
relative_pattern = r'/[^/]+/status/\d+'
```

### 5. Slack通知システム

#### 5.1 通知機能 (SlackNotifier)
- **ファイル**: `src/utils/slack_notifier.py`
- **処理内容**:
  - 実行結果の自動通知
  - 成功・失敗時の詳細レポート
  - カスタムメッセージ送信

```python
# 通知設定
SLACK_API_URL=http://api.kotube.net/slack_notify.php
SLACK_API_KEY=your_api_key
SLACK_WORKSPACE=eclair
```

#### 5.2 通知内容
- **成功時**: 実行サマリー、成功率、各アクション数
- **失敗時**: エラー詳細、スタックトレース
- **フィールド情報**: 実行時刻、処理ポスト数、成功率等

#### 5.3 通知制御
- **--skip-slack**: 通知をスキップするオプション
- **エラーハンドリング**: ネットワークエラー時の適切な処理

### 6. アクション実行フェーズ

#### 6.1 個別ポスト処理 (ActionHandler)
- **ファイル**: `src/automation/action_handler.py`
- **処理内容**:
  - 各ポストページへの移動
  - フォロー・リポスト・いいねの実行
  - アクション結果の記録

#### 6.2 フォロー処理
- **処理手順**:
  1. フォローボタンの検出
  2. 既フォロー状態の確認
  3. フォローボタンのクリック
  4. フォロー完了の確認

```python
# フォロー状態確認
success_texts = ['フォロー中', 'Following', 'フォロー済み']
```

#### 6.3 リポスト処理
- **処理手順**:
  1. リポストボタンの検出・クリック
  2. 確認ダイアログの処理
  3. リポスト実行の確認

#### 6.4 いいね処理
- **処理手順**:
  1. いいねボタンの検出
  2. 既いいね状態の確認
  3. いいねボタンのクリック

## セレクタ管理システム

### セレクタ設定ファイル
- **ファイル**: `config/selectors.json`
- **構造**:
  - login: ログイン関連セレクタ
  - search: 検索関連セレクタ
  - post_actions: ポストアクション関連セレクタ
  - timeline: タイムライン関連セレクタ
  - fallback: フォールバックセレクタ

### フォールバック機能
- **目的**: UI変更への対応
- **実装**: 複数セレクタの順次試行
- **例**:
```python
# メインセレクタで失敗した場合、フォールバックセレクタを試行
selectors = [
    "[data-testid='follow']",      # メイン
    "button:has-text('フォロー')"   # フォールバック
]
```

## エラーハンドリング戦略

### 1. 要素検出エラー
- **対応**: 複数セレクタによるフォールバック
- **タイムアウト**: 要素ごとに適切な待機時間設定
- **ログ**: 失敗したセレクタと成功したセレクタを記録

### 2. ネットワークエラー
- **対応**: リトライ機能
- **待機**: 指数バックオフによる再試行間隔
- **ログ**: ネットワーク状態とエラー詳細を記録

### 3. ログインエラー
- **検出**: エラーメッセージの監視
- **対応**: 認証情報の再確認要求
- **ログ**: エラー種別と対応策を記録

### 4. レート制限エラー
- **検出**: HTTP 429ステータス監視
- **対応**: 動的遅延時間の調整
- **ログ**: 制限発生時刻と復旧時刻を記録

## パフォーマンス最適化

### 1. 遅延制御
- **ランダム遅延**: 人間らしい操作間隔の模倣
- **動的調整**: エラー発生時の遅延時間増加
- **設定可能**: 環境変数による遅延時間調整

### 2. メモリ管理
- **ブラウザリソース**: 適切なクリーンアップ
- **ログローテーション**: ファイルサイズ制限
- **一時ファイル**: 実行後の自動削除

### 3. 並行処理制限
- **シーケンシャル実行**: アカウント制限回避
- **バッチ処理**: 適切な単位での処理分割

## セキュリティ考慮事項

### 1. 認証情報保護
- **環境変数**: .envファイルでの管理
- **ログマスキング**: パスワード情報の非表示
- **ファイル権限**: 設定ファイルのアクセス制限

### 2. ブラウザセキュリティ
- **サンドボックス**: 必要最小限の権限
- **HTTPS**: 暗号化通信の強制
- **Cookie保護**: セキュアな保存場所

### 3. レート制限遵守
- **API制限**: プラットフォーム規約の遵守
- **アクセス頻度**: 適切な間隔での実行
- **監視**: 異常なアクセスパターンの検出

## 監視・ログ機能

### 1. 実行ログ
- **アクション記録**: 各操作の成功/失敗
- **パフォーマンス**: 実行時間の測定
- **エラー詳細**: 例外情報とスタックトレース

### 2. 統計情報
- **成功率**: アクション別の成功率計算
- **処理時間**: 各フェーズの実行時間
- **リソース使用量**: メモリ・CPU使用率

### 3. アラート機能
- **エラー閾値**: 連続失敗時の通知
- **パフォーマンス劣化**: 実行時間異常の検出
- **リソース枯渇**: メモリ不足等の警告

## 設定管理

### 1. 環境設定
```bash
# 必須設定
X_USERNAME=your_username
X_PASSWORD=your_password

# 基本設定
MAX_POSTS_PER_SESSION=10
DELAY_MIN=2
DELAY_MAX=5
HEADLESS=true
STEALTH_MODE=true

# ブラウザ設定
BROWSER_PATH=/usr/bin/brave-browser

# ログ設定
LOG_DIR=logs

# Slack通知設定
SLACK_API_URL=http://api.kotube.net/slack_notify.php
SLACK_API_KEY=your_api_key
SLACK_WORKSPACE=eclair

# スクロール設定
MAX_SCROLL_ATTEMPTS=10
ELEMENT_TIMEOUT=15000
```

### 2. 実行時パラメータ
```bash
# コマンドライン引数
--headless          # ヘッドレスモード
--visible           # ブラウザ表示モード
--max-posts N       # 最大処理ポスト数
--debug             # デバッグモード
--skip-slack        # Slack通知をスキップ
```

## トラブルシューティング

### 1. よくある問題
- **ログイン失敗**: 認証情報の確認
- **要素検出失敗**: セレクタの更新
- **ネットワークタイムアウト**: 接続環境の確認

### 2. デバッグ手順
1. デバッグモードでの実行
2. ログファイルの確認
3. セレクタの動作確認
4. ネットワーク状態の確認

### 3. 復旧手順
1. Cookie情報のクリア
2. ブラウザプロファイルの再作成
3. セレクタ設定の更新
4. 遅延時間の調整

## 実行スクリプト

### run_automation.sh
- **機能**: X自動化ツールの実行スクリプト
- **cron対応**: スケジュール実行に最適化
- **ログ管理**: 実行ログの自動記録・ローテーション

```bash
# 使用例
./run_automation.sh --headless --max-posts 20
./run_automation.sh --visible --debug
./run_automation.sh --skip-slack  # Slack通知なし
```

### 実行環境管理
- **仮想環境**: 自動アクティベート
- **前提条件チェック**: 必要ファイルの存在確認
- **クリーンアップ**: 実行後の適切な後処理

## 最新機能

### 1. 直接URL検索方式
- **従来**: 検索バーへの入力方式
- **現在**: 直接URL叩き方式（https://x.com/search?q=...&src=typed_query&f=live）
- **利点**: より安定した検索処理、UI変更の影響を受けにくい

### 2. Slack通知システム
- **実行結果の自動通知**: 成功・失敗時の詳細レポート
- **カスタムAPI**: 専用Slack通知APIを使用
- **制御オプション**: --skip-slackで通知をスキップ可能

### 3. カスタムログディレクトリ
- **柔軟な出力先**: .envファイルでログディレクトリを指定可能
- **パス形式**: 相対パス・絶対パス両方に対応
- **自動作成**: 指定ディレクトリが存在しない場合は自動作成

### 4. 改善された検索処理
- **段階的読み込み**: domcontentloaded → load → 基本ナビゲーション
- **タイムアウト最適化**: 各段階で適切なタイムアウト設定
- **エラー回復**: タイムアウト時でも検索ページ到達を確認

## 今後の拡張予定

### 1. 機能拡張
- **スケジュール実行**: cron連携の強化
- **複数アカウント対応**: アカウント切り替え機能
- **高度なフィルタリング**: コンテンツ品質判定

### 2. 技術改善
- **非同期処理**: パフォーマンス向上
- **AI統合**: 自然言語処理による判定
- **クラウド対応**: スケーラブルな実行環境

---

*このドキュメントは auto_repost システムの技術仕様を詳細に記述したものです。*
*システムの理解と保守に活用してください。*
